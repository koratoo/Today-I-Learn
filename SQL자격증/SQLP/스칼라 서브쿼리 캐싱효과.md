스칼라 서브쿼리(scalar subquery)의 **캐싱 효과**는 옵티마이저가 **성능 최적화**를 위해 동일한 서브쿼리 결과를 **반복 계산하지 않고 한 번만 계산하여 재사용**하는 메커니즘을 의미합니다. 아래에 자세히 설명할게요.

---

### 🔸 스칼라 서브쿼리란?

* **SELECT 절 또는 WHERE 절**에 사용되는 서브쿼리로, \*\*항상 단일 행(single row)과 단일 열(single column)\*\*을 반환해야 합니다.

```sql
SELECT empno,
       (SELECT deptname FROM dept WHERE dept.deptno = emp.deptno) AS deptname
FROM emp;
```

---

### 🔸 캐싱 효과의 개념

스칼라 서브쿼리가 **상수처럼 고정된 값**을 반환하거나, **같은 값이 반복적으로 계산될 때**, 옵티마이저나 실행 엔진은 이 값을 **한 번만 실행하고 캐시에 저장**한 뒤, 나머지 부분에서는 **재사용**합니다. 이로 인해 **불필요한 반복 실행을 방지**하게 되어 성능이 향상됩니다.

---

### 🔸 예제

```sql
SELECT ename,
       sal,
       (SELECT MAX(sal) FROM emp) AS max_sal
FROM emp;
```

* 여기서 `(SELECT MAX(sal) FROM emp)`는 모든 행마다 실행될 수 있는 구조입니다.
* 하지만 이 쿼리는 결과가 **변하지 않는 상수 값**이므로, Oracle은 이 값을 한 번만 계산하고 **캐싱**합니다.
* 이로 인해 테이블을 반복 스캔하지 않고 **1회만 수행한 결과를 모든 행에 적용**할 수 있습니다.

---

### 🔸 캐싱이 발생하는 조건

* 서브쿼리 결과가 **입력값과 무관하게 항상 일정**한 경우 (즉, 상수).
* 혹은 **입력값이 반복적으로 동일**한 경우.

Oracle은 내부적으로 입력값이 같으면 이전 결과를 **매핑 테이블처럼 저장하고 재사용**합니다 (마치 해시 캐시처럼 동작).

---

### 🔸 캐싱이 일어나지 않는 경우

* 서브쿼리에 **입력값이 매번 달라지는 경우**, 즉, \*\*상호 상관 서브쿼리(correlated subquery)\*\*에서는 **매번 계산**이 필요합니다.

```sql
SELECT empno,
       (SELECT MAX(sal) FROM emp e2 WHERE e2.deptno = e1.deptno) AS max_sal_by_dept
FROM emp e1;
```

* 이 경우는 `e1.deptno`가 행마다 다르기 때문에, **부서마다 다른 결과**를 반환하므로 캐싱의 이점이 **제한적**입니다.

---

### ✅ 요약

| 상황                  | 캐싱 발생 여부 | 설명            |
| ------------------- | -------- | ------------- |
| 결과가 고정된 스칼라 서브쿼리    | ✅ 발생     | 최초 1회 실행 후 캐시 |
| 반복 입력값이 있는 스칼라 서브쿼리 | ✅ 발생     | 입력값 기준으로 캐싱   |
| 상관 서브쿼리로 입력값이 매번 다름 | ❌ 미발생    | 매번 새로 실행 필요   |

